#API Кассы

API для касcы — программный интерфейс системы для взаимодействия с онлайн-кассой.

Интерфейс работает по адресу [api.cloudpayments.ru](https://api.cloudpayments.ru) и поддерживает функции для фискализации кассы, а также формирования и выдачи кассовых чеков.

## Архитектура

API использует REST архитектуру. Параметры передаются методом **POST** в формате **JSON**, кодировке **UTF-8** с обязательным указанием заголовка **Content-Type**: *application/json*.

Ответ система выдает в **JSON** формате, который как минимум включает в себя два параметра: **Success** и **Message**:

```js
{ "Success": false, "Message": "Invalid Amount value" }
```

Первый параметр указывает на результат выполнения запроса – успешно или нет, второй может содержать дополнительную информацию.

### Аутентификация запросов

Для аутентификации запроса используется <a href="https://en.wikipedia.org/wiki/Basic_access_authentication" target="_blank">HTTP Basic Auth</a> — отправка логина и пароля в заголовке HTTP-запроса. В качестве логина используется **Public ID**, в качестве пароля — **API Secret**. Оба этих значения можно получить в личном кабинете.

<aside class="warning">Если в запросе не передан заголовок с данными аутентификации или переданы неверные данные, система вернет HTTP статус 401 – Unauthorized.</aside>

<aside class="notice">API secret используется для обеспечения безопасности. Он должен хранится в защищенном месте.</aside>

### Идемпотентность API

**Идемпотентность** — свойство API при повторном запросе выдавать тот же результат, что на первичный без повторной обработки. Это значит, что вы можете отправить несколько запросов к системе с одинаковым идентификатором, при этом обработан будет только один запрос, а все ответы будут идентичными. Таким образом реализуется защита от сетевых ошибок, которые приводят к созданию дублированных записей и действий.

Для включения идемпотентности необходимо в запросе к API передавать заголовок с ключом **X-Request-ID**, содержащий уникальный идентификатор. Формирование идентификатора запроса остается на вашей стороне — это может быть guid, комбинация из номера заказа, даты и суммы или любое другое значение на ваше усмотрение.

Каждый новый запрос, который необходимо обработать, должен включать новое значение **X-Request-ID**. Обработанный результат хранится в системе в течение 1 часа.



## Тестовый метод

Для проверки взаимодействия с API можно вызвать тестовый метод.  

**Адрес метода:**  
https://api.cloudpayments.ru/test

**Параметры запроса:**  
Отсутствуют.  
 
**Пример ответа:**  
В ответ метод возвращает статус запроса.

```llvm
{"Success":true,"Message":"bd6353c3-0ed6-4a65-946f-083664bf8dbd"}
```

## Фискализация кассы

Метод перевода интернет-кассы в фискальный режим работы (первичная регистрация).

**Адрес метода:**  
https://api.cloudpayments.ru/kkt/fiscalize

**Параметры запроса:**  

Параметр | Формат | Применение | Описание
--------- | ------- | ----------- | ----------- 
Inn |	Строка |	Обязательный |	ИНН организации или индивидуального предпринимателя — пользователя кассы
DeviceNumber |	Строка |	Обязательный |	Заводской номер кассы
FiscalNumber |	Строка |	Обязательный |	Номер фискального накопителя
RegNumber |	Строка |	Обязательный |	Регистрационный номер кассы
Url |	Строка |	Обязательный |	Адрес сайта (сайтов) — место расчетов
Ofd |	Строка |	Обязательный |	Оператор фискальный данных, см. [справочник](#operatory-fiskalnyh-dannyh)
TaxationSystem |	Массив значений |	Обязательный |	Одно или несколько значений системы налогообложения, см. [справочник](#taxationsystem)
MerchantEmail |	Строка |	Обязательный |	Email магазина
MerchantPhone |	Строка |	Необязательное |	Телефон магазина
IsBso |	Булевое |	Необязательное |	Для бланков строгой отчётности (БСО)

**Пример запроса:**

```llvm
{
   "Inn":"7708806062",                      //ИНН
   "DeviceNumber":"00000000000000000001",   //заводской номер кассы
   "FiscalNumber":"9999078900005430",       //номер ФН
   "RegNumber":"0000000004030311",          //регистрационный номер кассы
   "Url":"www.cloudpayments.ru",            //ваш адрес сайта
   "Ofd":"PeterService",                    //ОФД
   "TaxationSystem":[0],                    //системы налогообложения
   "MerchantEmail":"my@mail.ru",            //Email магазина
   "MerchantPhone":"899999999",             //Телефон магазина
   "IsBso":false,                           //БСО
}
```

Фискализация кассы является асинхронной операцией, поэтому в ответ на запрос API система сообщает, что команда поставлена в очередь и будет обработана в течение нескольких минут. Отчет о регистрации придет на элекронную почту, а кроме того, вы можете включить [Kkt](#kkt) уведомление в личном кабинете.

**Пример ответа:**

```js
{"Success":true,"Message":"Fiscal data queued"}
```

<aside class="notice">Функцию фискализации кассы через API имеет смысл использовать, если у вас десятки или сотни касс. Для остальных случаев проще выполнять регистрационные действия через личный кабинет.</aside>

## Формирование кассового чека

Метод формирования кассового чека.

**Адрес метода:**  
https://api.cloudpayments.ru/kkt/receipt

**Параметры запроса:** 

Параметр | Формат | Применение | Описание
--------- | ------- | ----------- | ----------- 
Inn |	Строка |	Обязательный |	ИНН вашей организации или ИП, на который зарегистрирована касса
Type |	Строка |	Обязательный |	Признак расчета, см. [ниже](#type)
CustomerReceipt|	JSON |	Обязательный |	Состав чека см. [ниже](#customerreceipt) 
InvoiceId |	Строка |	Необязательный |	Номер заказа в вашей системе
AccountId |	Строка |	Необязательный |	Идентификатор пользователя в вашей системе


При указании e-mail адреса или номера телефона плательщика, система автоматически отправит письмо с чеком или сообщение со ссылкой на чек. Вы также можете не указывать контакты, а самостоятельно отправлять покупателю чек в электронной форме с указанием фискальных реквизитов, полученных в уведомлении [Receipt](#receipt).

### Type

В таблице ниже представлены типы чеков и соответствующие им признаки расчета, которые используются для выдачи кассовых чеков.

| Тип | Признак расчета | Описание | 
|:--------- | :------- | :----------- |
Income |	Приход |	Выдается при получении средств от покупателя (клиента)
IncomeReturn |	Возврат прихода |	Выдается при возврате покупателю (клиенту) средств, полученных от него
Expense |	Расход |	Выдается при выдаче средств покупателю (клиенту)
ExpenseReturn |	Возврат расхода |	Выдается при получении средств от покупателя (клиента), выданных ему

### CustomerReceipt 

Параметры формирования чека/состав чека.  
Объект **CustomerReceipt** также может быть передан в параметре **Data** с вызовом <a href="https://developers.cloudpayments.ru/#parametry" target="_blank">виджета</a>, либо в любом другом платёжном методе CloudPayments (например, <a href="https://developers.cloudpayments.ru/#oplata-po-kriptogramme" target="_blank">оплата по криптограмме</a>, по <a href="https://developers.cloudpayments.ru/#oplata-po-tokenu-rekarring" target="_blank">токену</a>, <a href="https://developers.cloudpayments.ru/#podtverzhdenie-oplaty" target="_blank">подтверждении оплаты</a>, <a href="https://developers.cloudpayments.ru/#vozvrat-deneg" target="_blank">возвратах денежных средств</a>, <a href="https://developers.cloudpayments.ru/#izmenenie-podpiski-na-rekurrentnye-platezhi" target="_blank">изменений подписки</a> и др.) для формирования чека прихода при успешном платеже.

Параметр | Формат | Применение | Описание
|:--------- | :------- | :------- | :------- |
Items | JSON | Обязательный | Содержимое позиций чека, см. [ниже](#items). Действует ограничение на максимальное количество позиций в чеке (100 штук). Если их больше - пробьется несколько чеков максимум по 100 позиций в каждом.
TaxationSystem | Строка | Обязательный  | Система налогообложения (необязательный, если у вас одна система налогообложения), см. [ниже](#taxationsystem)
Amounts | JSON | Обязательный  | Общая сумма платежа или возврата, см. [ниже](#amounts)
CalculationPlace | Строка | Необязательный  | Место осуществления расчёта
Email | Строка | Необязательный  | E-mail покупателя для отправки чека
Phone | Строка | Необязательный  |Телефон покупателя в формате без скобок и дефисов для отправки ссылки на чек 
CustomerInfo | Строка | Необязательный  | Покупатель, наименование организации или фамилия, имя, отчество (при наличии), серия и номер паспорта покупателя (клиента), тег ОФД 1227
CustomerInn | Строка | Необязательный  | ИНН покупателя, тег ОФД 1228
isBso | Булевый | Необязательный  | true, если чек является бланком строгой отчётности
AgentSign | Строка | Необязательный  | Признак агента, тег ОФД 1057,  см. [ниже](#agentsign)
CashierName | Строка | Необязательный |	Имя кассира, если не передать будет использован "Сист. Администратор"
AdditionalReceiptInfos | Массив строк | Необязательный | Дополнительная информация общая для чека, многострочная 


#### Items

Параметры  услуг/товарных позиций в чеке.

Параметр | Формат | Применение | Описание
|:--------- | :------- | :------- | :------- |
Label | Строка | Обязательный | Наименование товара или услуги
Price | Строка | Обязательный  | Цена за единицу товара/услуги
Quantity | Строка | Обязательный  | Количество
Vat | Строка | Обязательный  | Ставка НДС услуги/товара
Amount | Строка | Обязательный  | Price * Quantity c учетом скидки
Method | Строка | Необязательный  | Способ расчёта, см. [ниже](#method)
Object | Строка | Необязательный  | Предмет расчёта, см. [ниже](#object)
MeasurementUnit | Строка | Необязательный  | Единица измерения
Excise | Строка | Необязательный  | Сумма акциза
CountryOriginCode | Строка | Необязательный  | Код страны происхождения товара в соответствии с Общероссийским классификатором стран мира 3 символа, тег ОФД 1230
CustomsDeclarationNumber | Строка | Необязательный  | Регистрационный номер таможенной декларации 32 символа, тег ОФД 1231
AgentSign | Строка | Необязательный  | Признак агента, тег ОФД 1222,  см. [ниже](#agentsign)
AgentData | JSON | Необязательный  | Данные агента, тег ОФД 1223, см. [ниже](#agentdata)
PurveyorData | JSON | Необязательный  | Данные поставщика платежного агента,  тег ОФД 1224, см. [ниже](#purveyordata)
ProductCodeData | JSON | Необязательный  | Данные маркировки товара, тег ОФД 1162, см. [ниже](#productcodedata)
AdditionalPositionInfo | Строка	| Необязательный | Дополнительная информация внутри конкретной позиции чека


##### Vat

Значения ставки НДС.

Код |	Описание
--------- | ------- | 
null или не указано  |	НДС не облагается
0 |	НДС 0%
10 | НДС 10%
20 | НДС 20%
110 | Расчетный НДС 10/110
120 | Расчетный НДС 20/120
12 | НДС 12% (только для онлайн-касс в Казахстане)

<aside class="notice">При указании ставки НДС будьте внимательны: "НДС 0%" и "НДС не облагается" — это не равнозначные варианты.</aside>

##### Method

Признак способа расчета.

Код |	Описание
--------- | ------- |
0 |	Unknown, неизвестный способ расчета
1 |	FullPrepayment, предоплата 100%
2 | PartialPrepayment, предоплата
3 |	AdvancePay, аванс
4 | FullPay, полный расчёт
5 |	PartialPayAndCredit, частичный расчёт и кредит
6 |	Credit, передача в кредит
7 |	CreditPayment, оплата кредита

<aside class="notice">Unknown - значение по умолчанию (при неуказании способа расчёта в ОФД отправляется FullPrepayment). В электронной форме чека не отображается.</aside>

##### Object

Признак предмета расчета.

Код |	Описание
--------- | ------- |
0 |	Unknown, неизвестный предмет оплаты 
1 |	Commodity, товар
2 | ExcisedCommodity, подакцизный товар
3 |	Job, работа
4 | Service, услуга
5 |	GamblingBet, ставка азартной игры
6 |	GamblingWin, выигрыш азартной игры
7 |	LotteryTicket, лотерейный билет
8 |	LotteryWin, выигрыш лотереи
9 | RidAccess, предоставление РИД
10 | Payment, платеж
11 | AgentReward, агентское вознаграждение
12 | Composite, составной предмет расчета
13 | Another, иной предмет расчета
14 | PropertyLaw, Имущественное право
15 | NonOperatingIncome, Внереализационный доход
16 | InsuranceContributions, Страховые взносы
17 | TradeFee, Торговый сбор
18 | ResortFee, Курортный сбор
19 | CautionMoney, Залог

<aside class="notice">Unknown - значение по умолчанию (при неуказании предмета расчёта в ОФД отправляется Commodity). В электронной форме чека не отображается.</aside>



##### AgentData 

Данные агента, Тег ОФД 1223.

Параметр |	Формат |	 Применение | Описание
--------- | ------- | ----------- | -------
AgentOperationName |	Строка | Обязательно, если [AgentSign](#agentsign) (1222) = 0, 1	| Наименование операции банковского платежного агента или банковского платежного субагента, тег ОФД 1044
PaymentAgentPhone |	Строка | Обязательно, если [AgentSign](#agentsign) (1222) = 0, 1, 2, 3	| Телефон платежного агента, тег ОФД 1073
PaymentReceiverOperatorPhone |	Строка | Обязательно, если [AgentSign](#agentsign) (1222) = 2, 3	| Телефон оператора по приему платежей, тег ОФД 1074
TransferOperatorPhone |	Строка | Обязательно, если [AgentSign](#agentsign) (1222) = 0, 1 | Телефон оператора перевода, тег ОФД 1075
TransferOperatorName |	Строка | Обязательно, если [AgentSign](#agentsign) (1222) = 0, 1	| Наименование оператора перевода, тег ОФД 1026
TransferOperatorAddress |	Строка | Обязательно, если [AgentSign](#agentsign) (1222) = 0, 1	| Адрес оператора перевода, тег ОФД 1005
TransferOperatorInn |	Строка | Обязательно, если 	[AgentSign](#agentsign) (1222) = 0, 1 | ИНН оператора перевода, тег ОФД 1016


##### PurveyorData

Данные поставщика платежного агента, Тег ОФД 1224.

Параметр |	Формат |	 Применение | Описание
--------- | ------- | ----------- | -----------
Name |	Строка |    Обязательный | 	Наименование поставщика, тег ОФД 1225
Inn |	Строка |	Обязательный | ИНН поставщика, тег ОФД 1226
Phone |	Строка |	Необязательный | Телефон поставщика, тег ОФД 1171

##### ProductCodeData

Данные маркировки товара.

Параметр |	Формат |	 Применение | Описание
--------- | ------- | ----------- | -----------
CodeProductNomenclature |	Строка | Необязательный | HEX представление штрих/бар кода маркировки целиком (Только для касс Микропэй)


#### TaxationSystem

В таблице ниже представлены варианты систем налогообложения юридических лиц и индивидуальных предпринимателей, которые используются при формировании кассовых чеков.

| Код | Система налогообложения |
|:--------- | :------- |
0 |	Общая система налогообложения
1 |	Упрощенная система налогообложения (Доход)
2 |	Упрощенная система налогообложения (Доход минус Расход)
3 |	Единый налог на вмененный доход
4 |	Единый сельскохозяйственный налог
5 |	Патентная система налогообложения

<aside class="notice">При неуказании системы налогообложения чек формируется с первой указанной при фискализации.</aside>


#### AgentSign

Признак агента, Тег ОФД 1057, 1222.  
Для корректного формирования при указаннии признака агента необходимо:  
В каждой товарной позиции указывать [данные агента](#agentdata) (AgentData, Тег 1223) и [данные поставщика](#purveyordata) (PurveyorData, Тег 1224).  

Код |	Описание
--------- | ------- | 
0 |	"Банковский платежный агент", Оказание услуг пользователем, являющимся банковским платежным агентом
1 |	"Банковский платежный субагент", Оказание услуг пользователем, являющимся банковским платежным субагентом
2 | "Платежный агент", Оказание услуг пользователем, являющимся платежным агентом
3 |	"Платежный субагент", Оказание услуг пользователем, являющимся платежным субагентом
4 | "Поверенный", Оказание услуг пользователем, являющимся поверенным
5 |	"Комиссионер", Оказание услуг пользователем, являющимся комиссионером
6 |	"Агент", Оказание услуг пользователем, являющимся агентом и не являющимся банковским платежным агентом (субагентом), платежным агентом (субагентом), поверенным, комиссионером

<aside class="notice">Данный параметр можно передавать вместе с каждой позицией в Items.</aside>
<aside class="warning">Не рекомендуется использование данного параметра одновременно внутри объекта Items и в CustomerReceipt.</aside>

#### Amounts
	
Общая сумма платежа или возврата.
Должна содержать в себе, как минимум, один из следующих параметров.

Параметр |	Формат |	Применение | Описание
--------- | ------- | ----------- | -----------
Electronic |	Строка |	Необязательный |	Сумма оплаты электронными деньгами
AdvancePayment |	Строка |	Необязательный |	Сумма предоплаты
Credit |	Строка |	Необязательный |	Сумма постоплатой
Provision |	Строка |	Необязательный |	Сумма встречным предоставлением

<aside class="notice">Сумма всех параметров в amounts должна совпадать с суммой по всем позициям в Items </aside>


### Пример запроса

```llvm
{
	"Inn": "7708806062", //ИНН
	"InvoiceId": "1234567", //номер заказа, необязательный
	"AccountId": "user@example.com", //идентификатор пользователя, необязательный
	"Type": "Income", //признак расчета
	"CustomerReceipt":
    {
		"Items": //товарные позициии
        [
			{
				"label": "Наименование товара 1", //наименование товара или услуги
				"price": 100.00, //цена
				"quantity": 1.00, //количество
				"amount": 100.00, //сумма
				"vat": 0, //ставка НДС
                "method": 0, // тег-1214 признак способа расчета - признак способа расчета
			    "object": 0, // тег-1212 признак предмета расчета - признак предмета товара, работы, услуги, платежа, выплаты, иного предмета расчета
                "measurementUnit": "шт"//единица измерения
			},
            {
				"label": "Наименование товара 2", //наименование товара или услуги
				"price": 200.00, //цена
				"quantity": 2.00, //количество
				"amount": 300.00, //сумма со скидкой 25%
				"vat": 10, //ставка НДС
                "method": 0, // тег-1214 признак способа расчета - признак способа расчета
			    "object": 0, // тег-1212 признак предмета расчета - признак предмета товара, работы, услуги, платежа, выплаты, иного предмета расчета
                "measurementUnit": "шт", //единица измерения
				"excise": 0.01, // тег-1229 сумма акциза
                "countryOriginCode": "156", // тег-1230 цифровой код страны происхождения товара в соответствии с Общероссийским классификатором стран мира 3 симв. 
                "customsDeclarationNumber": "54180656/1345865/3435625/23", // тег-1231 регистрационный номер таможенной декларации 32 симв.
                "ProductCodeData": //данные маркировки товара
                        { 
                        "CodeProductNomenclature":"3031303239303030303033343....a78495a4f6672754744773d3d" //HEX представление штрих/бар кода маркировки целиком (Только для касс Микропэй)
                        }
			}, 
            {
				"label": "Наименование товара 3", //наименование товара или услуги
				"price": 300.00, //цена
   				"quantity": 3.00, //количество
   				"amount": 900.00, //сумма
   				"vat": 20, //ставка НДС
                "method": 0, // тег-1214 признак способа расчета - признак способа расчета
   			    "object": 0, // тег-1212 признак предмета расчета - признак предмета товара, работы, услуги, платежа, выплаты, иного предмета расчета
                "measurementUnit": "шт", //единица измерения
   				"AgentSign": 6, //признак агента, тег ОФД 1222
				"AgentData": //данные агента, тег офд 1223
                { 
    				"AgentOperationName": null, // наименование операции банковского платежного агента или банковского платежного субагента, тег ОФД 1044
       				"PaymentAgentPhone": null,  // телефон платежного агента, тег ОФД 1073
       				"PaymentReceiverOperatorPhone": null, // телефон оператора по приему платежей, тег ОФД 1074
       				"TransferOperatorPhone": null, // телефон оператора перевода, тег ОФД 1075
       				"TransferOperatorName": null, // наименование оператора перевода, тег ОФД 1026
       				"TransferOperatorAddress": null, // адрес оператора перевода, тег ОФД 1005
       				"TransferOperatorInn": null // ИНН оператора перевода, тег ОФД 1016
       			},
       			"PurveyorData":  //данные поставщика платежного агента,  тег ОФД 1224
                { 
       				"Phone": "+74951234567", // телефон поставщика, тег ОФД 1171
       				"Name": "ООО Ромашка", // наименование поставщика, тег ОФД 1225
       				"Inn": "1234567890" // ИНН поставщика, тег ОФД 1226
       			}
       		}
		],
		"calculationPlace": "www.my.ru", //Место осуществления расчёта
        "taxationSystem": 0, //система налогообложения; необязательный, если у вас одна система налогообложения
		"email": "user@example.com", //e-mail покупателя, если нужно отправить письмо с чеком
		"phone": "", //телефон покупателя в любом формате, если нужно отправить сообщение со ссылкой на чек
		"customerInfo": "", // тег-1227 Покупатель наименование организации или фамилия, имя, отчество (при наличии), серия и номер паспорта покупателя (клиента)
		"customerInn": "7708806063", // тег-1228 ИНН покупателя 
        "isBso": false, //чек является бланком строгой отчётности
		"AgentSign": null, //признак агента, тег ОФД 1057
		"amounts":
	    {
		    "electronic": 1300.00, // Сумма оплаты электронными деньгами
		    "advancePayment": 0.00, // Сумма из предоплаты (зачетом аванса) (2 знака после запятой)
		    "credit": 0.00, // Сумма постоплатой(в кредит) (2 знака после запятой)
		    "provision": 0.00 // Сумма оплаты встречным предоставлением (сертификаты, др. мат.ценности) (2 знака после запятой)
	    }
	}
}
```

Формирование чека является асинхронной операцией, поэтому в ответ на запрос API система сообщает, что чек поставлен в очередь и будет обработан кассой в течение нескольких секунд. Для получения результата операции, вы можете включить [Receipt](#receipt) уведомление в личном кабинете. При постановке чека в очередь, ему присваивается уникальный идентификатор.

**Пример ответа:** *запрос принят успешно:*

```js
{
    "Model": {
        "Id": "QSnuAqV",
        "ErrorCode": 0
    },
    "InnerResult": null,
    "Success": true,
    "Message": "Queued",
    "Warning": null
}
```

**Пример ответа:** *запрос принят успешно (но имеется сообщение требующее внимания):*

```js
{
    "Model": {
        "Id": "FrBuAok",
        "ErrorCode": 0
    },
    "InnerResult": null,
    "Success": true,
    "Message": "Queued",
    "Warning": "01801810008658: Буфер ФН переполнен - Необходима замена ФН"
}
```

**Пример ответа:** *некорректный запрос:*

```js
{
    "Model": {
        "ErrorCode": -1
    },
    "InnerResult": null,
    "Success": false,
    "Message": "Компания с ИНН 7777777777 не найдена"
}
```

В случае ошибки в поле Model возвращается объект с полем **ErrorCode** (см. [справочник](#kody-oshibok))

## Запрос статуса чека

Метод получения статуса чека.  

**Адрес метода:**  
https://api.cloudpayments.ru/kkt/receipt/status/get

**Параметры запроса:** 

Параметр | Формат | Применение | Описание
--------- | ------- | ----------- | -----------
Id |	Строка |	Обязательный |	Идентификатор чека

**Пример запроса:**

```shell
{ "Id": "Nr9eTaj" }
```

**Пример ответа (чек успешно обработался):**

```llvm
{
   "Model": "Processed",
   "Success": true
}
```

**Пример ответа (чек не пробился):**

```llvm
{
   "Model": "Error",
   "InnerResult": null,
   "Success": true,
   "Message": "Нет касс без признака БСО для организации с ИНН ..."
}
```

**Пример ответ (чек в очереди):**

```llvm
{
   "Model": "Queued",
   "Success": true
}
```

**Пример ответ (чек не найден):**

```llvm
{
   "Model": "NotFound",
   "Success": true
}
```

## Получение данных чека

Метод получения детализации чека.

**Адрес метода:**   
https://api.cloudpayments.ru/kkt/receipt/get

**Параметры запроса:** 

Параметр | Формат | Применение | Описание
--------- | ------- | ----------- | -----------
Id |	Строка |	Обязательный |	Идентификатор чека

**Пример запроса:**

```llvm
{ "Id": "Nr9eTaj" }
```

**Пример ответа:**

```llvm
{
    "Model": {
        "Email": "user@example.com",
        "Phone": null,
        "Items": [
            {
                "Label": "Товар 1",
                "Price": 100,
                "Quantity": 1,
                "Amount": 100,
                "Department": null,
                "Vat": 0,
                "EAN13": null,
                "AgentSign": null,
                "Method": 6,
                "Object": 3,
                "MeasurementUnit": "шт",
                "AgentData": null,
                "PurveyorData": null
            },
            {
                "Label": "Товар 2",
                "Price": 220,
                "Quantity": 2.5,
                "Amount": 550,
                "Department": null,
                "Vat": 10,
                "EAN13": null,
                "AgentSign": 2,
                "Method": 0,
                "Object": 0,
                "MeasurementUnit": null,
                "AgentData": {
                    "PayingAgentOperation": null,
                    "PayingAgentPhone": null,
                    "ReceivePaymentsOperatorPhone": null,
                    "MoneyTransferOperatorPhone": null,
                    "MoneyTransferOperatorName": null,
                    "MoneyTransferOperatorAddress": null,
                    "MoneyTransferOperatorVATIN": null
                },
                "PurveyorData": null
            },
            {
                "Label": "Товар 3",
                "Price": 150,
                "Quantity": 5,
                "Amount": 600,
                "Department": null,
                "Vat": 20,
                "EAN13": null,
                "AgentSign": null,
                "Method": 0,
                "Object": 0,
                "MeasurementUnit": null,
                "AgentData": null,
                "PurveyorData": null
            }
        ],
        "TaxationSystem": 2,
        "Amounts": null,
        "IsBso": false,
        "AdditionalData": {
            "Id": "Nr9eTaj",
            "AccountId": "user@example.com"
            "Amount": 1150,
            "CalculationPlace": "www.my.ru",
            "CashierName": "test",
            "DateTime": "2018-11-14T16:19:33",
            "DeviceNumber": "00000000000000000001",
            "DocumentNumber": "1323",
            "FiscalNumber": "9999078900005430",
            "FiscalSign": "13223",
            "InvoiceId": "1322223",
            "Ofd": "Первый ОФД",
            "OfdReceiptUrl": "http://url.com/adress",
            "OrganizationInn": "7708806062",
            "QrCodeUrl": "https://qr.cloudpayments.ru/receipt?q=t%3d20181205T185000%26s%3d99.00%26fn%3d9999078900005430%26i%3d157347%26fp%3d1016954666%26n%3d1",
            "RegNumber": "322223",
            "SenderEmail": "sender@email.com",
            "SessionCheckNumber": "12223",
            "SessionNumber": "1",
            "SettlePlace": "117342, Москва, ул. Бутлерова, 17Б",
            "TransactionId": 14442,
            "Type": "Income",
        }
    },
    "InnerResult": null,
    "Success": true,
    "Message": null
}
```


## Формирование чека коррекции

Метод формирования чека коррекции.

**Адрес метода:**  
https://api.cloudpayments.ru/kkt/correction-receipt

**Параметры запроса:**

Параметр | Формат | Применение | Описание
--------- | ------- | ----------- | -----------
CorrectionReceiptData |  JSON |  Обязательный |    Состав чека см. [ниже](#correctionreceiptdata)
### CorrectionReceiptData

Параметры формирования чека/состав чека.

Параметр | Формат | Применение | Описание
--------- | ------- | ----------- | -----------
OrganizationInn			|	Строка		|	Обязательный 	|	ИНН организации
VatRate					|	Строка		|	Обязательный 	|	Ставка НДС, см. [ниже](#vatrate)
TaxationSystem			|	Строка		|	Обязательный 	|	Система налогообложения, см. [ниже](#taxationsystem)
DeviceNumber			|	Строка		|	Обязательный 	|	Номер ККТ
CorrectionReceiptType	|	Строка		|	Обязательный 	|	Признак расчета коррекции, см. [ниже](#correctionreceipttype)
CauseCorrection			|	JSON		|	Обязательный 	|	Основание для коррекции, см. [ниже](#causecorrection)
Amounts					|	JSON		|	Обязательный	|	Общая сумма платежа или возврата, см. [выше](#amounts)
CashierName				|	Строка		|	Необязательный	|	Имя кассира
CashierInn				|	Строка		|	Необязательный	|	ИНН кассира
PaymentPlace			|	Строка		|	Необязательный 	|	Место использования ККТ (сайт)
PaymentAddress			|	Строка		|	Необязательный 	|	Адрес использования ККТ
CorrectionType 			|	Строка		|	Необязательный 	|	Тип коррекции, см. [ниже](#correctiontype)

### CauseCorrection

Основание для коррекции

Параметр | Формат | Применение | Описание
--------- | ------- | ----------- | -----------
CorrectionDate			|	Строка		|	Обязательный	|	Дата документа основания для коррекции
CorrectionNumber		|	Строка		|	Обязательный 	|	Номер документа основания для коррекции

### VatRate

Код |   Ставка НДС
----|  -------
1	|	20
2 	|	10
3	|	20/120
4	|	10/110
5	|	0
6	|	Без НДС
### CorrectionType

Код	|	Тип коррекции
----| -------
0 	|	Самостоятельно
1 	|	По предписанию
### CorrectionReceiptType

Код	|	Признак расчета коррекции
----| -------
1 	|	Корректировка прихода
3	|   Корректировка расхода
### **Пример запроса**  

```js
{
  "correctionReceiptData": {
    "organizationInn": "7708806062",
    "cashierName": "Сист. администратор",
    "cashierInn": "7708806062",
    "deviceNumber": "01801810008669",
    "paymentPlace": "test_place.com",
    "paymentAddress": "117342, Москва, ул. Бутлерова, 17Б",
    "vatRate": 1,
    "taxationSystem": 1,
    "correctionType": 1,
    "correctionReceiptType": 1,
    "causeCorrection": {
      "correctionDate": "2021-07-27",
      "correctionNumber": "б//н"
    },
    "amounts": {
      "electronic": 150,
      "cash": 0,
      "advancePayment": 0,
      "credit": 0,
      "provision": 0
    }
  }
}
```
## Запрос статуса чека коррекции

Метод получения статуса чека.

**Адрес метода:**
https://api.cloudpayments.ru/kkt/correction-receipt/status/get

**Параметры запроса:**

Параметр | Формат | Применение | Описание
--------- | ------- | ----------- | -----------
Id		|	Строка |	Обязательный |	Идентификатор чека

**Пример запроса:**  

```llvm
{ "Id": "xzuQd6Ag" }
```

**Пример ответа (чек успешно обработался):**  

```llvm
{
   "Model": "Processed",
   "Success": true
}
```

**Пример ответа (чек не пробился):**  

```llvm
{
   "Model": "Error",
   "InnerResult": null,
   "Success": true,
   "Message": "Описание ошибки"
}
```

**Пример ответ (чек в очереди):**  

```llvm
{
   "Model": "Queued",
   "Success": true
}
```

**Пример ответ (чек не найден):**  

```llvm
{
   "Model": "NotFound",
   "Success": true
}
```
## Получение данных чека коррекции

Метод получения детализации чека.

**Адрес метода:**  
https://api.cloudpayments.ru/kkt/correction-receipt/get

**Пример запроса:**  

```llvm
{
    "Id": "xzuQd6Ag" 
}
```

**Пример ответа:**  

```js
{
    "Model": {
        "Status": "Processed",
        "ErrorCode": null,
        "ErrorMessage": null,
        "Amounts": {
            "Electronic": 150.0,
            "Cash": 0.0,
            "AdvancePayment": 0.0,
            "Credit": 0.0,
            "Provision": 0.0,
            "Sum": 150.0
        },
        "Items": [],
        "TaxationSystem": 1,
        "CorrectionType": 1,
        "CorrectionReceiptType": 1,
        "VatRate": 1,
        "CorrectionDate": "2021-07-26T21:00:00Z",
        "CorrectionNumber": "б//н",
        "Id": "xzuQd6Ag",
        "Amount": 150.0,
        "PaymentPlace": "test_place.com",
        "PaymentAddress": "117342, Москва, ул. Бутлерова, 17Б",
        "CashierName": "Сист. администратор",
        "DeviceNumber": "01801810008669",
        "DocumentNumber": "602",
        "FiscalNumber": "9999078902009571",
        "FiscalSign": "2451182224",
        "OfdName": "ООО «ПЕТЕР-СЕРВИС Спецтехнологии»",
        "OfdInn": "7841465198",
        "OfdReceiptUrl": null,
        "OrganizationInn": "7708806062",
        "RegNumber": "0000000480013321",
        "SessionCheckNumber": "3",
        "SessionNumber": "13"
    },
    "InnerResult": null,
    "Success": true,
    "Message": null
}
```

## Изменение состояния кассы
Метод ручного управления состоянием кассы.
Касса может быть принудительно выключена (отправлена на техобслуживание) и включена (введена в эксплуатацию).

**Адрес метода:**  
https://api.cloudpayments.ru/kkt/state  

**Параметры запроса:** 

Параметр | Формат | Применение | Описание
--------- | ------- | ----------- | ----------- 
Inn |	Строка |	Обязательный |	ИНН организации или индивидуального предпринимателя — пользователя кассы
DeviceNumber |	Строка |	Обязательный |	Заводской номер кассы
FiscalNumber |	Строка |	Обязательный |	Номер фискального накопителя
OnMaintenance |	Булевый |	Обязательный |	Флаг, указывающий, нужно ли помещать кассу на техобслуживание

**Пример запроса:**

```llvm
{
   "Inn":"7708806062",                      //ИНН
   "DeviceNumber":"00000000000000000001",   //заводской номер кассы
   "FiscalNumber":"9999078900005430",       //номер ФН
   "OnMaintenance":true          //признак техобслуживания
}
```

**Пример ответа:**

```js
{"Success":true,"Message":"Kkt status was changed"}
```

## Получение данных кассы

Метод получения данных кассы.  

**Адрес метода:**  
https://api.cloudpayments.ru/kkt/state/get

**Параметры запроса:** 

Параметр | Формат | Применение | Описание
--------- | ------- | ----------- | -----------
DeviceNumber |	Строка |	Обязательный |	Заводской номер кассы
FiscalNumber |	Строка |	Обязательный |	Номер фискального накопителя

**Пример запроса:**

```llvm
{
   "DeviceNumber": "00000000000000000001",   //заводской номер кассы
   "FiscalNumber": "9999078900005430",       //номер ФН
}
```

**Пример ответа:**

```llvm
{
"Model": {
        "Inn": "7708806062", //ИНН
        "DeviceNumber": "01801810008669",  //Заводской номер кассы
        "RegNumber": "0000000370021655", //Регистрационный номер ККМ
        "FiscalNumber": "9999078902005454", //Номер ФН
        "Status": 1, //Статус 1-онлайн, 2-оффлайн, 3-ошибка
        "Fiscal": true, //ККМ фискализирована
        "OfdName": "ОФД Группа Элемент", //ОФД
        "SettlePlace": "117342, Москва, ул. Бутлерова, 17Б", //место нахождения (установки) ккм
        "CalculationPlace": "www.my.ru", //Место осуществления расчёта
        "KkmModelName": "MicroPay-ФАС", //Название модели кассового аппарата
        "FiscalDateEnd": "2022-02-18T00:00:00+03:00", //Дата окончания фискального накопителя
        "FirmwareVersion": "MP 087", //Версия прошивки кассы
        "IsBso": false //Для бланков строгой отчётности
    }
    "InnerResult": null,
    "Success": true,
    "Message": null
}
```