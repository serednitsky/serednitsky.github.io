# Уведомления

Уведомление — HTTP-запрос от системы к вашему сайту. Подобные запросы также называют **callback** или **webhook**. 

<aside class="warning">Включение и отключение уведомлений, а также настройка адресов и форматов уведомлений выполняется в ЛК.</aside>
<aside class="notice">Для уведомления Receipt действует следующее правило: если система не сможет соединиться с сервером ТСП или получит некорректный ответ либо ответ с кодом, отличным от нуля, то будет совершено 100 попыток доставить сообщение с интервалом между повторами в минутах: 1, 2, 5, 10, 30. Тайм-аут ожидания ответа — 30 секунд. Менее чем в 1% случаев задержка доставки может достигать 2 минуты. В остальных случаях — меньше 1 секунды.</aside>

## Receipt

Выполняется после выдачи кассового чека.

Служит для информирования о сформированных онлайн-чеках: система отправляет запрос на адрес ТСП с информацией о чеке, а сайт должен зафиксировать информацию.

Параметры передаются в теле запроса, список представлен в следующей таблице:

Параметр | Формат | Применение | Описание
--------- | ------- | ----------- | ----------- 
Id |	Строка |	Обязательный |	Уникальный идентификатор чека
DocumentNumber |	Целое число |	Обязательный |	Номер чека
SessionNumber |	Целое число |	Обязательный |	Номер смены
Number |	Целое число |	Обязательный |	Номер чека в смене
FiscalSign |	Строка |	Обязательный |	Фискальный признак документа
DeviceNumber |	Целое число |	Обязательный |	Заводской номер ККТ
RegNumber |	Строка |	Обязательный |	Регистрационный номер ККТ
FiscalNumber |	Строка |	Обязательный |	Номер фискального накопителя
Inn |	Число |	Обязательный |	ИНН
Type |	Строка |	Обязательный |	Признак расчета, см. [справочник](#type)
Ofd |	Строка |	Обязательный |	Наименование оператора фискальных данных
Url |	Строка |	Обязательный |	URL адрес с копией чека
QrCodeUrl |	Строка |	Обязательный |	URL адрес с QR кодом для проверки чека в ФНС
TransactionId |	Целое число |	Необязательный |	Идентификатор транзакции
Amount |	Число |	Обязательный |	Сумма чека
DateTime |	yyyy-MM-dd HH:mm:ss |	Обязательный |	Дата/время выдачи чека во временной зоне UTC
InvoiceId |	Строка |	Необязательный |	Номер заказа
AccountId | Строка |	Необязательный |	Идентификатор пользователя
Receipt |	JSON |	Обязательный | Состав чека
CalculationPlace |	Строка |	Необязательный |	Место осуществления расчетов
CashierName |	Строка |	Необязательный |	Имя кассира
SettlePlace |	Строка |	Необязательный |	место нахождения (установки) ккм

В ответ на запрос система ожидает получить ответ в JSON формате с обязательным параметром code:

```js
{"code":0}
```

Код определяет результат обработки сервером ТСП уведомления о чеке и может принимать единственное значение:

Код |	Значение
---- | ------- 
0 |	Чек зарегистрирован

## Принцип работы и проверка уведомлений

Параметры передаются методом POST или GET в теле запроса в формате «ключ=значение».

Уведомление [receipt](#receipt) содержит 2 HTTP-заголовка **X-Content-HMAC** и **Content-HMAC**, в котором находится проверочное значение запроса, вычисленное с помощью алгоритма <a href="https://ru.wikipedia.org/wiki/HMAC" target="_blank">HMAC</a>. Отличие между ними только в том, что первый генерируется из URL decoded (или не encoded) параметров, а второй генерируется из URL encoded параметров (что может вызывать проблемы). Если вам необходимо проверять подлинность и целостность уведомлений, вы можете вычислить проверочное значение на своей стороне и сравнить с тем, что пришло в запросе. Совпадение подтверждает, что уведомление было отправлено от нас и пришло к вам в оригинальном виде.

При реализации проверки сообщения обратите внимание на следующие моменты:

* Для уведомлений, отправленных методом **POST**, сообщением является тело запроса. Для **GET** — строка параметров;
* Хэш вычисляется функцией **SHA256**;  
* В качестве ключа используется API Secret, который можно получить в личном кабинете;  
* Вычисленное значение передается в кодировке **base64**.

<a href="http://www.jokecamp.com/blog/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages/" target="_blank">Примеры вычисления HMAC</a> на разных языках программирования.

Адреса, с которых система отправляет уведомления — **130.193.70.192** и **185.98.85.109**. Добавлены новые подсети адресов - 91.142.84.0/27, 87.251.91.160/27 и 185.98.81.0/28.  

<aside class="warning">В связи с мировыми трендами и выявленными уязвимостями вынуждены отказаться от поддержки протокола SSL3. Поддержка закончилась 8 июня.</aside>

Для вас это означает что:

* Если вы не используете Receipt уведомления, то делать ничего не нужно.

* Если вы используете это уведомление, то нужно проверить, какие протоколы шифрования https поддерживает ваш сервер. Если ваш сервер поддерживает только SSL3, то нужно обновить его минимум до TLS11. Ещё лучше — до TLS13. В крайнем случае вы можете перевести уведомления на http-протокол.  

Более подробно, [как отказаться от SSL3](https://disablessl3.com).
После 8 июня https-уведомления на сервера, поддерживающие только SSL3, могут не доставляться.

</br>
</br>
</br>
 